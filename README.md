# üöÄ Servicio de Autenticaci√≥n - Microservicio

Este es el servicio de autenticaci√≥n para la plataforma de contenido multimedia, desarrollado con NestJS, PostgreSQL, Redis y Docker.

## üìã Caracter√≠sticas

- ‚úÖ Autenticaci√≥n JWT
- ‚úÖ Registro y login de usuarios
- ‚úÖ Sistema de roles (USER, MODERATOR, ADMIN)
- ‚úÖ Promoci√≥n de usuarios a moderadores
- ‚úÖ Documentaci√≥n Swagger autom√°tica
- ‚úÖ Validaciones con class-validator
- ‚úÖ Tests unitarios con Jest
- ‚úÖ Docker y Docker Compose

## üõ†Ô∏è Tecnolog√≠as

- **Framework**: NestJS con TypeScript
- **Base de datos**: PostgreSQL 15
- **Cache**: Redis 7
- **ORM**: TypeORM
- **Autenticaci√≥n**: JWT + Passport
- **Documentaci√≥n**: Swagger/OpenAPI
- **Testing**: Jest
- **Contenedores**: Docker & Docker Compose

## üöÄ Instalaci√≥n y Ejecuci√≥n

### Prerrequisitos
- Docker y Docker Compose instalados
- Git

### 1. Clonar el repositorio
```bash
git clone <url-del-repositorio>
cd chat-media-and-notifications-with-sockets
```

### 2. Ejecutar en Modo Desarrollo (Recomendado)
```bash
# Construir y ejecutar todos los servicios en modo desarrollo
docker-compose up --build

# Ejecutar en segundo plano
docker-compose up -d --build

# Ver logs en tiempo real
docker-compose logs -f auth-service
```

### 3. Ejecutar en Modo Producci√≥n
```bash
# Usar el archivo de producci√≥n
docker-compose -f docker-compose.prod.yml up --build

# Ejecutar en segundo plano
docker-compose -f docker-compose.prod.yml up -d --build
```

### 4. Verificar que los servicios est√©n funcionando
```bash
# Ver estado de contenedores
docker-compose ps

# Verificar salud de los servicios
curl http://localhost:5900/auth/health
```

### 5. Detener y limpiar servicios
```bash
# Detener servicios
docker-compose down

# Detener y eliminar vol√∫menes (CUIDADO: elimina datos)
docker-compose down -v

# Limpiar sistema Docker
docker system prune -f
```

## üåê Servicios y Puertos

| Servicio | Puerto | URL | Descripci√≥n |
|----------|--------|-----|-------------|
| **Auth Service** | 5900 | http://localhost:5900 | API de autenticaci√≥n |
| **Swagger Docs** | 5900 | http://localhost:5900/api/docs | Documentaci√≥n API |
| **PostgreSQL** | 5432 | localhost:5432 | Base de datos |
| **Redis** | 6379 | localhost:6379 | Cache y sesiones |
| **pgAdmin** | 5050 | http://localhost:5050 | Administrador de BD (solo desarrollo) |

## üîë Credenciales por Defecto

### Base de Datos PostgreSQL
- **Host**: localhost
- **Puerto**: 5432
- **Base de datos**: `auth_db`
- **Usuario**: `admin`
- **Contrase√±a**: `admin123`

### pgAdmin (Administrador de Base de Datos)
- **URL**: http://localhost:5050
- **Email**: `admin@admin.com`
- **Contrase√±a**: `admin123`

### Redis
- **Host**: localhost
- **Puerto**: 6379
- **Sin contrase√±a**

### JWT
- **Secret**: `mi_super_secreto_jwt_para_autenticacion_2024`
- **Expiraci√≥n**: 24 horas

## üìö Endpoints de la API

### Autenticaci√≥n
| M√©todo | Endpoint | Descripci√≥n | Autenticaci√≥n |
|--------|----------|-------------|---------------|
| POST | `/auth/register` | Registrar nuevo usuario | No |
| POST | `/auth/login` | Iniciar sesi√≥n | No |
| GET | `/auth/profile` | Obtener perfil del usuario | JWT |
| POST | `/auth/refresh` | Renovar token | JWT |
| POST | `/auth/promote-to-moderator` | Promover a moderador | JWT + ADMIN |
| GET | `/auth/health` | Estado del servicio | No |

### Documentaci√≥n Swagger
Visita http://localhost:5900/api/docs para ver la documentaci√≥n interactiva completa.

## üß™ Testing

```bash
# Ejecutar tests dentro del contenedor
docker-compose exec auth-service npm test

# Ejecutar tests con cobertura
docker-compose exec auth-service npm run test:cov

# Ejecutar tests en modo watch
docker-compose exec auth-service npm run test:watch
```

## üë• Roles de Usuario

### USER (Por defecto)
- Acceso b√°sico a la plataforma
- Puede ver su propio perfil

### MODERATOR
- Puede moderar contenido
- Acceso a funciones de moderaci√≥n

### ADMIN
- Acceso completo al sistema
- Puede promover usuarios a moderadores
- Gesti√≥n completa de usuarios

## üîß Configuraci√≥n de Desarrollo

### Variables de Entorno
Copia el archivo `auth-service/env.example` y ajusta las variables seg√∫n necesites:

```bash
cp auth-service/env.example auth-service/.env
```

### Desarrollo Local (sin Docker)
```bash
cd auth-service
npm install
npm run start:dev
```

## üìù Ejemplos de Uso

### 1. Registrar un nuevo usuario
```bash
curl -X POST http://localhost:5900/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario@ejemplo.com",
    "password": "mipassword123",
    "firstName": "Juan",
    "lastName": "P√©rez"
  }'
```

### 2. Iniciar sesi√≥n
```bash
curl -X POST http://localhost:5900/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "usuario@ejemplo.com",
    "password": "mipassword123"
  }'
```

### 3. Obtener perfil (con token)
```bash
curl -X GET http://localhost:5900/auth/profile \
  -H "Authorization: Bearer TU_TOKEN_JWT"
```

### 4. Promover usuario a moderador (solo ADMIN)
```bash
curl -X POST http://localhost:5900/auth/promote-to-moderator \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN_DE_ADMIN" \
  -d '{
    "userId": "uuid-del-usuario"
  }'
```

## üóÑÔ∏è Configuraci√≥n de pgAdmin

### **Configuraci√≥n Manual del Servidor PostgreSQL**

1. **Ejecuta los servicios**: 
   ```bash
   docker-compose up -d
   ```

2. **Accede a pgAdmin**: http://localhost:5050

3. **Inicia sesi√≥n** con:
   - **Email**: `admin@admin.com`
   - **Contrase√±a**: `admin123`

4. **Agregar servidor PostgreSQL**:
   - Clic derecho en "Servers" (en el panel izquierdo)
   - Selecciona **"Create" ‚Üí "Server..."**

5. **Pesta√±a "General"**:
   - **Name**: `Auth Database` (o el nombre que prefieras)
   - **Comments**: `Servicio de Autenticaci√≥n` (opcional)

6. **Pesta√±a "Connection"**:
   - **Host name/address**: `postgres-auth` ‚ö†Ô∏è **¬°MUY IMPORTANTE: NO uses `localhost`!**
   - **Port**: `5432`
   - **Maintenance database**: `auth_db`
   - **Username**: `admin`
   - **Password**: `admin123`
   - **Save password**: ‚úÖ **Marcar esta opci√≥n**

7. **Pesta√±a "SSL" (Opcional)**:
   - **SSL mode**: `Prefer` (recomendado)

8. **Clic "Save"**

### **Verificar la Conexi√≥n**

Si todo est√° correcto, deber√≠as ver:
- ‚úÖ **Servidor "Auth Database"** en el panel izquierdo con icono verde
- ‚úÖ **Base de datos `auth_db`** expandible
- ‚úÖ **Esquema `public`** con sus tablas
- ‚úÖ **Tabla `users`** (se crea autom√°ticamente cuando el servicio de auth ejecuta)

### **Datos de Conexi√≥n de Referencia R√°pida**

| Campo | Valor | Notas |
|-------|-------|-------|
| **Host** | `postgres-auth` | ‚ö†Ô∏è NO `localhost` |
| **Puerto** | `5432` | Puerto est√°ndar PostgreSQL |
| **Base de datos** | `auth_db` | BD principal del servicio |
| **Usuario** | `admin` | Usuario con todos los permisos |
| **Contrase√±a** | `admin123` | Contrase√±a del usuario admin |

### **¬øPor qu√© usar `postgres-auth` como host?**

üîë **Concepto clave**: Dentro de Docker Compose, los contenedores se comunican usando **nombres de servicios** como hostnames, NO `localhost`:

```yaml
postgres-auth:  # ‚Üê Este nombre es el hostname dentro de la red Docker
  image: postgres:15-alpine
  container_name: postgres-auth
```

- **`localhost`** = Se refiere al propio contenedor de pgAdmin
- **`postgres-auth`** = Se refiere al contenedor de PostgreSQL

### **Troubleshooting pgAdmin**

#### **‚ùå pgAdmin no inicia o se reinicia constantemente**
```bash
# Limpiar pgAdmin y recrearlo
docker-compose down
docker volume rm chat-media-andnotifications-with-sockets_pgadmin_data
docker-compose up pgadmin -d
```

#### **‚ùå Error "could not connect to server: Connection refused"**

**Causa**: Problema de conectividad de red o PostgreSQL no est√° ejecut√°ndose.

**Soluci√≥n**:
```bash
# 1. Verificar que PostgreSQL est√© ejecut√°ndose
docker-compose ps

# 2. Verificar logs de PostgreSQL
docker-compose logs postgres-auth

# 3. Probar conectividad desde pgAdmin a PostgreSQL
docker exec pgadmin-auth ping postgres-auth

# 4. Si sigue fallando, reiniciar PostgreSQL
docker-compose restart postgres-auth
```

#### **‚ùå Error "FATAL: password authentication failed for user admin"**

**Causa**: Credenciales incorrectas o problema de autenticaci√≥n.

**Soluci√≥n**:
```bash
# 1. Verificar que usas las credenciales correctas:
#    Usuario: admin
#    Contrase√±a: admin123

# 2. Si persiste, recrear PostgreSQL con configuraci√≥n limpia
docker-compose down
docker volume rm chat-media-andnotifications-with-sockets_postgres_auth_data
docker-compose up -d
```

#### **‚ùå Error "server closed the connection unexpectedly"**

**Causa**: PostgreSQL est√° sobrecargado o hay problema de configuraci√≥n.

**Soluci√≥n**:
```bash
# Reiniciar PostgreSQL
docker-compose restart postgres-auth

# O reiniciar todo el stack
docker-compose restart
```

#### **‚ùå Error "could not connect to server: Name or service not known"**

**Causa**: Est√°s usando `localhost` en lugar de `postgres-auth`.

**Soluci√≥n**:
- ‚úÖ Usa: `postgres-auth`
- ‚ùå NO uses: `localhost`, `127.0.0.1`, o la IP del contenedor

#### **‚ùå Error "Connection to the server has been lost"**

**Causa**: PostgreSQL se reinici√≥ o hay problemas de red.

**Soluci√≥n**:
```bash
# 1. Refrescar pgAdmin (F5 en el navegador)
# 2. Reconectarse al servidor en pgAdmin
# 3. Si persiste, verificar estado de contenedores
docker-compose ps
```

### **Verificaci√≥n Final**

Para confirmar que todo funciona:

```bash
# 1. Verificar todos los servicios
docker-compose ps

# 2. Probar API de autenticaci√≥n
curl http://localhost:5900/auth/health

# 3. Verificar PostgreSQL directamente
docker exec postgres-auth psql -U admin -d auth_db -c "SELECT current_database();"

# 4. Acceder a pgAdmin
# http://localhost:5050
```

**¬°Si sigues estos pasos exactamente, pgAdmin deber√≠a conectarse sin problemas!** üéØ

## üêõ Troubleshooting

### Problema: Los contenedores no inician
```bash
# Limpiar contenedores y vol√∫menes
docker-compose down -v
docker system prune -f
docker-compose up --build
```

### Problema: Error de conexi√≥n a la base de datos
```bash
# Verificar que PostgreSQL est√© ejecut√°ndose
docker-compose logs postgres-auth

# Reiniciar solo la base de datos
docker-compose restart postgres-auth
```

### Problema: Puerto ya en uso
```bash
# Cambiar puertos en docker-compose.yml si es necesario
# Por ejemplo, cambiar 5900:3000 por 5901:3000
```

### Problema: Error en npm ci
```bash
# El proyecto ahora usa npm install
# Si tienes problemas, limpia y reconstruye
docker-compose down
docker-compose build --no-cache
docker-compose up
```

## üìä Estructura del Proyecto

```
auth-service/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ auth/                 # M√≥dulo de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/             # DTOs de validaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/          # Guards de seguridad
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decorators/      # Decoradores personalizados
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ strategies/      # Estrategias de Passport
‚îÇ   ‚îú‚îÄ‚îÄ users/               # M√≥dulo de usuarios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entities/        # Entidades de TypeORM
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts        # M√≥dulo principal
‚îÇ   ‚îî‚îÄ‚îÄ main.ts             # Punto de entrada
‚îú‚îÄ‚îÄ test/                    # Tests e2e
‚îú‚îÄ‚îÄ Dockerfile              # Configuraci√≥n Docker (producci√≥n)
‚îú‚îÄ‚îÄ Dockerfile.dev          # Configuraci√≥n Docker (desarrollo)
‚îú‚îÄ‚îÄ .dockerignore           # Archivos excluidos de Docker
‚îú‚îÄ‚îÄ package.json            # Dependencias
‚îî‚îÄ‚îÄ tsconfig.json           # Configuraci√≥n TypeScript
```

### Diferencias entre Desarrollo y Producci√≥n

| Aspecto | Desarrollo | Producci√≥n |
|---------|------------|------------|
| **Dockerfile** | `Dockerfile.dev` | `Dockerfile` |
| **Hot Reload** | ‚úÖ S√≠ | ‚ùå No |
| **Vol√∫menes** | ‚úÖ C√≥digo montado | ‚ùå C√≥digo en imagen |
| **pgAdmin** | ‚úÖ Incluido | ‚ùå No incluido |
| **Build** | ‚ùå No requerido | ‚úÖ Build en imagen |
| **Comando** | `npm run start:dev` | `npm run start:prod` |

## üîÑ Pr√≥ximos Pasos

Este es el primer microservicio de la plataforma. Los siguientes servicios a desarrollar ser√°n:

1. **Servicio de Contenido Multimedia** (puerto 5901)
2. **Servicio de Comentarios** (puerto 5902)
3. **Servicio de Notificaciones** (puerto 5903)
4. **Servicio de Procesamiento** (puerto 5904)

## üìû Soporte

Si tienes problemas o preguntas:

1. Revisa los logs: `docker-compose logs auth-service`
2. Verifica la documentaci√≥n Swagger: http://localhost:5900/api/docs
3. Ejecuta los tests para verificar funcionalidad: `npm test`

---

**¬°El servicio de autenticaci√≥n est√° listo para usar! üéâ** 